packer {
  required_plugins {
    vsphere = {
      source  = "github.com/hashicorp/vsphere"
      version = "~> 1"
    }
  }
}
# Variable Declaration Section 
{# variable vcenter_username is set in .vsphere-secrets.json on packer-build-host #}
variable "vcenter_username" {
  type        = string
  description = "The username to login to the vCenter Server instance."
  sensitive   = true
}
{# variable vcenter_password is set in .vsphere-secrets.json on packer-build-host #}
variable "vcenter_password" {
  type        = string
  description = "The password for the login to the vCenter Server instance."
  sensitive   = true
}

variable "HTTP_IP" {
  type    = string
  default = "{{packer_builder_hostname}}.{{domain}}"
}

variable "HTTP_PATH" {
  type    = string
  default = "{{kickstart_filename}}"
}

variable "version" {
  type    = string
  default = "{{packer_build_version}}"
}

# VM Section
source "vsphere-iso" "autogenerated_1" {
  CPU_hot_plug         = true
  CPUs                 = {{vm_template_cpu}}
  RAM                  = {{vm_template_ram}}
  RAM_hot_plug         = true
  boot_command         = ["<up><tab> text ip={{vm_template_ip}}::{{vm_template_gateway}}:{{vm_template_subnet}}:{{vm_template_hostname}}:ens192:none ipv6.disable=1 nameserver={{vm_template_dns_server_ip}} inst.ks=http://{{packer_builder_ip}}/{{kickstart_filename}}<enter><wait><enter>"]
  cluster              = "{{vcenter_cluster}}"
  convert_to_template  = true
  create_snapshot      = false
  datacenter           = "{{vcenter_datacenter}}"
  datastore            = "{{vcenter_datastore}}"
  disk_controller_type = ["pvscsi"]
  folder               = "{{vcenter_templatefolder}}"
  guest_os_type        = "{{vm_guestostype}}"
  host                 = "{{vcenter_esxhost}}"
  insecure_connection  = "true"
  iso_paths            = ["{{vcenter_iso_path}}"] 
  network_adapters {
    network      = "{{vcenter_network}}"
    network_card = "vmxnet3"
  }
  notes            = "Template RockyLinux version"
  password         = var.vcenter_password {# variable is set in .vsphere-secrets.json on packer-build-host #}

  shutdown_command = "/sbin/halt -h -p"
  ssh_password     = "{{vm_root_userpassword}}"
  ssh_username     = "{{vm_root_user}}"
  storage {
    disk_size             = {{vm_template_disk}}
    disk_thin_provisioned = true
  }
  username       = var.vcenter_username {# variable is set in .vsphere-secrets.json on packer-build-host #}

  vcenter_server = "{{vcenter_fqdn}}"
  vm_name        = "template-rocky8-{{packer_build_version}}"
}

# a build block invokes sources and runs provisioning steps on them. The
# documentation for build blocks can be found here:
# https://www.packer.io/docs/templates/hcl_templates/blocks/build
build {
  sources = ["source.vsphere-iso.autogenerated_1"]

  provisioner "shell" { 
    execute_command   = "bash {#'{{ .Path }}'#}"
    expect_disconnect = true
    script            = "{{packer_scripts_directory}}requirements.sh"
  }

}
